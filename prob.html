<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MaÅ¾ylio konverteris â€“ prob.html</title>
<style>
  :root{
    --bg:#0e1116; --ink:#e8eef5; --mut:#90a4ae;
    --card:#131a21; --edge:#1e2a38;
    --ok:#2ecc71; --bad:#e57373; --warn:#f9a825;
    --btn:#0dbf9b; --btn-ink:#07211c;
  }
  body{margin:0;font:16px/1.5 system-ui;background:var(--bg);color:var(--ink);padding:18px;}
  header,main{max-width:980px;margin:0 auto;}
  h1{margin:0 0 10px;font-size:1.6rem;}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:12px;padding:16px;margin-bottom:14px}
  label{display:block;margin:6px 0 4px;color:var(--mut)}
  input,select{width:100%;padding:10px;border-radius:8px;background:#101821;color:var(--ink);border:1px solid #263445}
  button{margin-top:10px;padding:10px 14px;border-radius:10px;background:var(--btn);color:var(--btn-ink);font-weight:700;border:0;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #223140;text-align:right}
  th:first-child,td:first-child{text-align:center}
  th{color:var(--mut);font-weight:600}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600}
  .good{background:rgba(46,204,113,.15);color:var(--ok);border:1px solid rgba(46,204,113,.35)}
  .bad{background:rgba(229,115,115,.12);color:var(--bad);border:1px solid rgba(229,115,115,.35)}
  .note{font-size:.9rem;color:var(--mut);margin-top:8px}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .ghost{background:#223041;color:#e8eef5}
</style>
</head>
<body>
<header>
  <h1>ğŸ¯ MaÅ¾ylio Greitas konverteris</h1>
  <p class="note">Ä®vesk koeficientus ir savo p â€“ pamatysi VALUE, sprendimÄ…, Kelly statymÄ…, rizikos patikrÄ… ir galÄ—si <b>vesti Å¾urnalÄ…</b> su CSV eksportu.</p>
</header>

<main>
  <!-- 1. Konverteris -->
  <section class="card">
    <label for="odds">Koeficientai (atskirti kableliais)</label>
    <input id="odds" placeholder="pvz.: 2.10, 3.40, 4.20" />
    <button id="calc">SkaiÄiuoti</button>

    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>#</th><th>Koef.</th><th>Implied p</th><th>Fair p</th><th>Fair koef.</th><th>Edge</th><th>VALUE</th><th>Sprendimas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 2. Kelly + Rizikos patikra -->
  <section class="card">
    <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr">
      <div>
        <label for="idx">Pasirinkimo numeris</label>
        <input id="idx" type="number" min="1" value="1" />
      </div>
      <div>
        <label for="pct">Tavo tikimybÄ— p (%)</label>
        <input id="pct" type="number" min="0" max="100" step="0.1" placeholder="pvz.: 55" />
      </div>
      <div>
        <label for="bank">Bankrolas (â‚¬)</label>
        <input id="bank" type="number" min="0" step="0.01" value="100" />
      </div>
      <div>
        <label for="frac">Kelly apimtis</label>
        <select id="frac">
          <option value="1">100% Kelly</option>
          <option value="0.5" selected>50% Kelly</option>
          <option value="0.25">25% Kelly</option>
        </select>
      </div>
    </div>

    <div class="btn-row">
      <button id="kgo">ApskaiÄiuoti Kelly</button>
      <button id="addlog" class="ghost" disabled>â• PridÄ—ti Ä¯ Å¾urnalÄ…</button>
    </div>

    <div id="kpi" class="note"></div>
  </section>

  <!-- 3. Å½urnalas + CSV -->
  <section class="card">
    <h3 style="margin:0 0 6px">ğŸ“’ Å½urnalas</h3>
    <div class="btn-row">
      <button id="dlcsv">â¬‡ï¸ AtsisiÅ³sti CSV</button>
      <button id="clear" class="ghost">ğŸ§¹ IÅ¡valyti Å¾urnalÄ…</button>
    </div>
    <table id="logtbl" style="display:none">
      <thead>
        <tr>
          <th>Laikas</th><th>Rinka</th><th>Pasirinkimas</th><th>Koef.</th><th>Tavo p%</th><th>Edge%</th><th>EV/â‚¬</th><th>Kellyâ‚¬</th><th>Sprendimas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="note">Pastaba: Äia â€“ planavimo Å¾urnalas. RealÅ³ P&L fiksuok <a href="risk.html">Rizikos modulyje</a>.</p>
  </section>
</main>

<script>
/*** UTIL ***/
const $ = id => document.getElementById(id);
const tbl = $('tbl'), tbody = tbl.querySelector('tbody');
const LOG_KEY = 'mazylis_prob_log_v1';

function toPct(x){ return (x*100).toFixed(2)+'%'; }
function clamp(x,a,b){ return Math.min(b,Math.max(a,x)); }
function csvEscape(v){ if(v==null) v=''; v=String(v); return /[",\n]/.test(v)?('"'+v.replace(/"/g,'""')+'"'):v; }
function download(name, text){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
}

/*** 1) KONVERTERIS ***/
let lastCalc = null; // {odds, fairOdds, fairP}

function parseOdds(){
  const parts = ($('odds').value||'').split(',').map(s=>parseFloat(s.trim())).filter(x=>x>1.0001);
  if(parts.length<2){ tbl.style.display='none'; lastCalc=null; return {odds:[]}; }

  const implied=parts.map(o=>1/o);
  const sumImp=implied.reduce((a,b)=>a+b,0);
  const norm=sumImp>0?1/sumImp:0;
  const fairP=implied.map(p=>p*norm);
  const fairOdds=fairP.map(p=>1/p);

  tbody.innerHTML='';
  parts.forEach((o,i)=>{
    const hasValue = o>fairOdds[i];
    const edge=((o/fairOdds[i])-1)*100;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${o.toFixed(2)}</td>
      <td>${toPct(1/o)}</td>
      <td>${toPct(fairP[i])}</td>
      <td>${fairOdds[i].toFixed(2)}</td>
      <td>${edge>=0?'+':''}${edge.toFixed(2)}%</td>
      <td>${hasValue?'<span class="pill good">TAIP</span>':'<span class="pill bad">NE</span>'}</td>
      <td>${hasValue?'Statyti':'Nestatyti'}</td>
    `;
    tbody.appendChild(tr);
  });
  tbl.style.display='';
  lastCalc = {odds:parts, fairOdds, fairP};
  // kol nÄ—ra Kelly, draudÅ¾iam â€PridÄ—ti Ä¯ Å¾urnalÄ…â€œ
  $('addlog').disabled = true;
}

/*** 2) KELLY + RIZIKOS PATIKRA ***/
let lastKelly = null; // {idx, o, pUser, bank, frac, fStar, stake, evPerEuro, decisionText}

function kelly(){
  if(!lastCalc || !lastCalc.odds.length){ $('kpi').textContent='Pirmiausia paskaiÄiuok kairÄ—je (SkaiÄiuoti).'; return; }
  const i=clamp(parseInt($('idx').value)-1,0,lastCalc.odds.length-1);
  const o=lastCalc.odds[i];
  const pUser=clamp(parseFloat($('pct').value)/100,0,1);
  const bank=Math.max(0,parseFloat($('bank').value)||0);
  const frac=parseFloat($('frac').value)||0;
  if(!pUser){ $('kpi').textContent='Ä®vesk savo tikimybÄ™ p (%).'; return; }

  const fStar=(((o-1)*pUser)-(1-pUser))/(o-1);
  const stake=Math.max(0,fStar)*bank*frac;
  const evPerEuro=pUser*(o-1)-(1-pUser);
  const decisionHtml=evPerEuro>0?'<span class="pill good">LaimÄ—s (ilgainiui)</span>':'<span class="pill bad">NelaimÄ—s (ilgainiui)</span>';

  $('kpi').innerHTML=`
    Pasirinkimas #${i+1}, koef.=${o.toFixed(2)}<br>
    Kelly f*=${fStar.toFixed(4)} â†’ statymas â‰ˆ ${stake.toFixed(2)} â‚¬ iÅ¡ bankrolas ${bank.toFixed(2)} â‚¬<br>
    EV/â‚¬=${evPerEuro.toFixed(4)} â†’ Sprendimas: ${decisionHtml}
  `;

  // Rizikos modulis
  try{
    const raw = localStorage.getItem('mazylis_risk_v1');
    if(raw){
      const d = JSON.parse(raw);
      const capMax = d.bank * (d.cap/100);
      const dayStop = -(d.bank * (d.dloss/100));
      const weekStop= -(d.bank * (d.wloss/100));
      const hitStop = (d.dayPL <= dayStop) || (d.weekPL <= weekStop);

      let html = `<br><b>ğŸ›¡ï¸ Rizikos patikra:</b> max pagal cap (${d.cap.toFixed(2)}%) = <b>â‚¬ ${capMax.toFixed(2)}</b>. `;
      html += stake > capMax
        ? `<span style="color:#e57373">âš ï¸ VirÅ¡ija cap â€“ maÅ¾ink iki â‚¬ ${capMax.toFixed(2)}.</span>`
        : `<span style="color:#2ecc71">âœ… Sutelpa Ä¯ cap.</span>`;
      if(hitStop){
        html += `<br><span style="color:#e57373;font-weight:700">ğŸ›‘ STOP â€“ pasiekta dienos/savaitÄ—s riba.</span>`;
      }
      html += `<br><a href="risk.html" style="display:inline-block;margin-top:6px;padding:8px 12px;background:#223041;border-radius:8px;color:#e8eef5;text-decoration:none">ğŸ” Patikrinti rizikos modulyje</a>`;
      $('kpi').insertAdjacentHTML('beforeend', html);
    } else {
      $('kpi').insertAdjacentHTML('beforeend',
        `<br><span style="color:#90a4ae">â„¹ï¸ Patogu: atsidaryk <a href="risk.html">Rizikos modulÄ¯</a> ir nustatyk bankrolÄ… bei cap â€“ tuomet Äia matysi cap patikrÄ….</span>`);
    }
  }catch(e){}

  // Ä¯simenam Kelly rezultatÄ… Å¾urnalui
  lastKelly = {
    idx: i+1, o, pUser, bank, frac, fStar, stake, evPerEuro,
    decisionText: evPerEuro>0 ? 'STATYTI' : 'NESTATYTI'
  };
  $('addlog').disabled = false;
}

/*** 3) Å½URNALAS + CSV ***/
function loadLog(){ try{return JSON.parse(localStorage.getItem(LOG_KEY)||'[]');}catch(e){return [];} }
function saveLog(rows){ localStorage.setItem(LOG_KEY, JSON.stringify(rows)); }
function renderLog(){
  const rows=loadLog();
  const tb=$('#logtbl tbody')||document.createElement('tbody');
  if(!$('#logtbl tbody')) $('#logtbl').appendChild(tb);
  tb.innerHTML='';
  rows.slice(-200).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.ts}</td><td>${r.market}</td><td>#${r.pick}</td>
      <td>${r.odd.toFixed(2)}</td>
      <td>${(r.p*100).toFixed(2)}%</td>
      <td>${(r.edge*100).toFixed(2)}%</td>
      <td>${(r.evPerEuro>=0?'+':'')+r.evPerEuro.toFixed(4)}</td>
      <td>${r.kelly.toFixed(2)} â‚¬</td>
      <td>${r.decision}</td>`;
    tb.appendChild(tr);
  });
  $('#logtbl').style.display = rows.length ? 'table' : 'none';
}

function addToLog(){
  if(!lastCalc || !lastKelly){ alert('Pirmiausia paskaiÄiuok Kelly.'); return; }
  const implied = 1/lastKelly.o;
  const edge = lastKelly.pUser - implied;
  const row = {
    ts: new Date().toISOString().slice(0,19).replace('T',' '),
    market: '1Xn',         // gali pakeisti pagal situacijÄ…
    pick: lastKelly.idx,
    odd: lastKelly.o,
    p: lastKelly.pUser,
    edge: edge,
    evPerEuro: lastKelly.evPerEuro,
    kelly: lastKelly.stake,
    decision: lastKelly.decisionText
  };
  const rows = loadLog(); rows.push(row); saveLog(rows); renderLog();
}

function toCSV(){
  const rows=loadLog();
  const header=['time','market','pick','odd','p','edge','ev_per_euro','kelly_eur','decision'];
  const lines=[header.join(',')].concat(rows.map(r=>[
    csvEscape(r.ts),csvEscape(r.market),csvEscape('#'+r.pick),
    r.odd.toFixed(2),
    (r.p*100).toFixed(2)+'%',
    (r.edge*100).toFixed(2)+'%',
    (r.evPerEuro>=0?'+':'')+r.evPerEuro.toFixed(4),
    r.kelly.toFixed(2),
    csvEscape(r.decision)
  ].join(',')));
  return lines.join('\n');
}

/*** EVENTAI ***/
$('calc').addEventListener('click',parseOdds);
$('kgo').addEventListener('click',kelly);
$('addlog').addEventListener('click',addToLog);
$('dlcsv').addEventListener('click',()=>download('mazylis_log.csv',toCSV()));
$('clear').addEventListener('click',()=>{ if(confirm('IÅ¡valyti Å¾urnalÄ…?')){ saveLog([]); renderLog(); } });

/*** INIT ***/
renderLog();
</script>
</body>
</html>
