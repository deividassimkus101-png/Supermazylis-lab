<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mažylio konverteris – prob.html</title>
<style>
  :root{
    --bg:#0e1116; --ink:#e8eef5; --mut:#90a4ae;
    --card:#131a21; --edge:#1e2a38;
    --ok:#2ecc71; --bad:#e57373; --warn:#f9a825;
    --btn:#0dbf9b; --btn-ink:#07211c;
  }
  body{margin:0;font:16px/1.5 system-ui;background:var(--bg);color:var(--ink);padding:18px;}
  header,main{max-width:980px;margin:0 auto;}
  h1{margin:0 0 10px;font-size:1.6rem;}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:12px;padding:16px;margin-bottom:14px}
  label{display:block;margin:6px 0 4px;color:var(--mut)}
  input,select{width:100%;padding:10px;border-radius:8px;background:#101821;color:var(--ink);border:1px solid #263445}
  button{margin-top:10px;padding:10px 14px;border-radius:10px;background:var(--btn);color:var(--btn-ink);font-weight:700;border:0;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #223140;text-align:right}
  th:first-child,td:first-child{text-align:center}
  th{color:var(--mut);font-weight:600}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600}
  .good{background:rgba(46,204,113,.15);color:var(--ok);border:1px solid rgba(46,204,113,.35)}
  .bad{background:rgba(229,115,115,.12);color:var(--bad);border:1px solid rgba(229,115,115,.35)}
  .note{font-size:.9rem;color:var(--mut);margin-top:8px}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .ghost{background:#223041;color:#e8eef5}
</style>
</head>
<body>
<header>
  <h1>🎯 Mažylio Greitas konverteris</h1>
  <p class="note">Konvertuok koefus, gauk Kelly + rizikos patikrą, veski žurnalą ir net <b>užfiksuok realų win/loss</b> čia pat – grafikas atsinaujina automatiškai.</p>
</header>

<main>
  <!-- 1. Konverteris -->
  <section class="card">
    <label for="odds">Koeficientai (atskirti kableliais)</label>
    <input id="odds" placeholder="pvz.: 2.10, 3.40, 4.20" />
    <button id="calc">Skaičiuoti</button>

    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>#</th><th>Koef.</th><th>Implied p</th><th>Fair p</th><th>Fair koef.</th><th>Edge</th><th>VALUE</th><th>Sprendimas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 2. Kelly + Rizikos patikra -->
  <section class="card">
    <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr">
      <div>
        <label for="idx">Pasirinkimo numeris</label>
        <input id="idx" type="number" min="1" value="1" />
      </div>
      <div>
        <label for="pct">Tavo tikimybė p (%)</label>
        <input id="pct" type="number" min="0" max="100" step="0.1" placeholder="pvz.: 55" />
      </div>
      <div>
        <label for="bank">Bankrolas (€)</label>
        <input id="bank" type="number" min="0" step="0.01" value="100" />
      </div>
      <div>
        <label for="frac">Kelly apimtis</label>
        <select id="frac">
          <option value="1">100% Kelly</option>
          <option value="0.5" selected>50% Kelly</option>
          <option value="0.25">25% Kelly</option>
        </select>
      </div>
    </div>

    <div class="btn-row">
      <button id="kgo">Apskaičiuoti Kelly</button>
      <button id="addlog" class="ghost" disabled>➕ Pridėti į žurnalą</button>
    </div>

    <div id="kpi" class="note"></div>
  </section>

  <!-- 3. Žurnalas + CSV -->
  <section class="card">
    <h3 style="margin:0 0 6px">📒 Žurnalas (planavimas)</h3>
    <div class="btn-row">
      <button id="dlcsv">⬇️ Atsisiųsti CSV</button>
      <button id="clear" class="ghost">🧹 Išvalyti žurnalą</button>
    </div>
    <table id="logtbl" style="display:none">
      <thead>
        <tr>
          <th>Laikas</th><th>Rinka</th><th>Pasirinkimas</th><th>Koef.</th><th>Tavo p%</th><th>Edge%</th><th>EV/€</th><th>Kelly€</th><th>Sprendimas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="note">Pastaba: čia – planavimo žurnalas. Žemiau – realių rezultatų fiksavimas.</p>
  </section>

  <!-- 4. GREITAS REALAUS REZULTATO FIKSAVIMAS (rašoma į rizikos saugyklą + grafikas atsinaujina) -->
  <section class="card">
    <h3 style="margin:0 0 6px">✅ Greitas rezultato fiksavimas (win/loss)</h3>
    <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr">
      <div>
        <label for="rStake">Statymas (€)</label>
        <input id="rStake" type="number" step="0.01" value="10">
      </div>
      <div>
        <label for="rOdd">Koef.</label>
        <input id="rOdd" type="number" step="0.01" value="2.00">
      </div>
      <div>
        <label for="rRes">Rezultatas</label>
        <select id="rRes">
          <option value="win">Laimėjo</option>
          <option value="loss">Pralaimėjo</option>
          <option value="void">Void / grąžinta</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="rCommit">💾 Įrašyti rezultatą</button>
      </div>
    </div>
    <p class="note" id="rMsg"></p>
  </section>

  <!-- 5. 📈 Realaus P&L grafikas (iš Risk log'o) -->
  <section class="card">
    <h3 style="margin:0 0 6px">📈 Realaus P&L grafikas</h3>
    <div class="btn-row">
      <button id="refreshPL" class="ghost">🔄 Atnaujinti grafiką</button>
    </div>
    <div id="plWrap" style="margin-top:10px; background:#101821; border:1px solid #223140; border-radius:10px; padding:8px;">
      <svg id="plChart" viewBox="0 0 600 240" preserveAspectRatio="none" style="width:100%; height:220px"></svg>
      <div id="plNote" class="note">Įrašai atnaujinami čia pat – paspausk „🔄 Atnaujinti grafiką“ po įrašo.</div>
    </div>
  </section>
</main>

<script>
/*** UTIL ***/
const $ = id => document.getElementById(id);
const tbl = $('tbl'), tbody = tbl.querySelector('tbody');
const LOG_KEY = 'mazylis_prob_log_v1';
const RISK_KEY = 'mazylis_risk_v1';

function toPct(x){ return (x*100).toFixed(2)+'%'; }
function clamp(x,a,b){ return Math.min(b,Math.max(a,x)); }
function csvEscape(v){ if(v==null) v=''; v=String(v); return /[",\n]/.test(v)?('"'+v.replace(/"/g,'""')+'"'):v; }
function download(name, text){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
}

/*** 1) KONVERTERIS ***/
let lastCalc = null;

function parseOdds(){
  const parts = ($('odds').value||'').split(',').map(s=>parseFloat(s.trim())).filter(x=>x>1.0001);
  if(parts.length<2){ tbl.style.display='none'; lastCalc=null; return {odds:[]}; }

  const implied=parts.map(o=>1/o);
  const sumImp=implied.reduce((a,b)=>a+b,0);
  const norm=sumImp>0?1/sumImp:0;
  const fairP=implied.map(p=>p*norm);
  const fairOdds=fairP.map(p=>1/p);

  tbody.innerHTML='';
  parts.forEach((o,i)=>{
    const hasValue = o>fairOdds[i];
    const edge=((o/fairOdds[i])-1)*100;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${o.toFixed(2)}</td>
      <td>${toPct(1/o)}</td>
      <td>${toPct(fairP[i])}</td>
      <td>${fairOdds[i].toFixed(2)}</td>
      <td>${edge>=0?'+':''}${edge.toFixed(2)}%</td>
      <td>${hasValue?'<span class="pill good">TAIP</span>':'<span class="pill bad">NE</span>'}</td>
      <td>${hasValue?'Statyti':'Nestatyti'}</td>
    `;
    tbody.appendChild(tr);
  });
  tbl.style.display='';
  lastCalc = {odds:parts, fairOdds, fairP};
  $('addlog').disabled = true;
}

/*** 2) KELLY + RIZIKA ***/
let lastKelly = null;

function kelly(){
  if(!lastCalc || !lastCalc.odds.length){ $('kpi').textContent='Pirmiausia paskaičiuok kairėje (Skaičiuoti).'; return; }
  const i=clamp(parseInt($('idx').value)-1,0,lastCalc.odds.length-1);
  const o=lastCalc.odds[i];
  const pUser=clamp(parseFloat($('pct').value)/100,0,1);
  const bank=Math.max(0,parseFloat($('bank').value)||0);
  const frac=parseFloat($('frac').value)||0;
  if(!pUser){ $('kpi').textContent='Įvesk savo tikimybę p (%).'; return; }

  const fStar=(((o-1)*pUser)-(1-pUser))/(o-1);
  const stake=Math.max(0,fStar)*bank*frac;
  const evPerEuro=pUser*(o-1)-(1-pUser);
  const decisionHtml=evPerEuro>0?'<span class="pill good">Laimės (ilgainiui)</span>':'<span class="pill bad">Nelaimės (ilgainiui)</span>';

  $('kpi').innerHTML=`
    Pasirinkimas #${i+1}, koef.=${o.toFixed(2)}<br>
    Kelly f*=${fStar.toFixed(4)} → statymas ≈ ${stake.toFixed(2)} € iš bankrolas ${bank.toFixed(2)} €<br>
    EV/€=${evPerEuro.toFixed(4)} → Sprendimas: ${decisionHtml}
  `;

  // Rizikos patikra (skaito RISK_KEY)
  try{
    const raw = localStorage.getItem(RISK_KEY);
    if(raw){
      const d = JSON.parse(raw);
      const capMax = d.bank * (d.cap/100);
      const dayStop = -(d.bank * (d.dloss/100));
      const weekStop= -(d.bank * (d.wloss/100));
      const hitStop = (d.dayPL <= dayStop) || (d.weekPL <= weekStop);

      let html = `<br><b>🛡️ Rizikos patikra:</b> max pagal cap (${d.cap.toFixed(2)}%) = <b>€ ${capMax.toFixed(2)}</b>. `;
      html += stake > capMax
        ? `<span style="color:#e57373">⚠️ Viršija cap – mažink iki € ${capMax.toFixed(2)}.</span>`
        : `<span style="color:#2ecc71">✅ Sutelpa į cap.</span>`;
      if(hitStop){
        html += `<br><span style="color:#e57373;font-weight:700">🛑 STOP – pasiekta dienos/savaitės riba.</span>`;
      }
      html += `<br><a href="risk.html" style="display:inline-block;margin-top:6px;padding:8px 12px;background:#223041;border-radius:8px;color:#e8eef5;text-decoration:none">🔍 Patikrinti rizikos modulyje</a>`;
      $('kpi').insertAdjacentHTML('beforeend', html);
    } else {
      $('kpi').insertAdjacentHTML('beforeend',
        `<br><span style="color:#90a4ae">ℹ️ Patogu: atsidaryk <a href="risk.html">Rizikos modulį</a> ir nustatyk bankrolą bei cap – tuomet čia matysi cap patikrą.</span>`);
    }
  }catch(e){}

  lastKelly = {
    idx: i+1, o, pUser, bank, frac, fStar, stake, evPerEuro,
    decisionText: evPerEuro>0 ? 'STATYTI' : 'NESTATYTI'
  };
  $('addlog').disabled = false;
}

/*** 3) ŽURNALAS + CSV (planavimo) ***/
function loadLog(){ try{return JSON.parse(localStorage.getItem(LOG_KEY)||'[]');}catch(e){return [];} }
function saveLog(rows){ localStorage.setItem(LOG_KEY, JSON.stringify(rows)); }
function renderLog(){
  const rows=loadLog();
  const tb=$('#logtbl tbody')||document.createElement('tbody');
  if(!$('#logtbl tbody')) $('#logtbl').appendChild(tb);
  tb.innerHTML='';
  rows.slice(-200).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.ts}</td><td>${r.market}</td><td>#${r.pick}</td>
      <td>${r.odd.toFixed(2)}</td>
      <td>${(r.p*100).toFixed(2)}%</td>
      <td>${(r.edge*100).toFixed(2)}%</td>
      <td>${(r.evPerEuro>=0?'+':'')+r.evPerEuro.toFixed(4)}</td>
      <td>${r.kelly.toFixed(2)} €</td>
      <td>${r.decision}</td>`;
    tb.appendChild(tr);
  });
  $('#logtbl').style.display = rows.length ? 'table' : 'none';
}

function addToLog(){
  if(!lastCalc || !lastKelly){ alert('Pirmiausia paskaičiuok Kelly.'); return; }
  const implied = 1/lastKelly.o;
  const edge = lastKelly.pUser - implied;
  const row = {
    ts: new Date().toISOString().slice(0,19).replace('T',' '),
    market: '1Xn',
    pick: lastKelly.idx,
    odd: lastKelly.o,
    p: lastKelly.pUser,
    edge: edge,
    evPerEuro: lastKelly.evPerEuro,
    kelly: lastKelly.stake,
    decision: lastKelly.decisionText
  };
  const rows = loadLog(); rows.push(row); saveLog(rows); renderLog();
}

function toCSV(){
  const rows=loadLog();
  const header=['time','market','pick','odd','p','edge','ev_per_euro','kelly_eur','decision'];
  const lines=[header.join(',')].concat(rows.map(r=>[
    csvEscape(r.ts),csvEscape(r.market),csvEscape('#'+r.pick),
    r.odd.toFixed(2),
    (r.p*100).toFixed(2)+'%',
    (r.edge*100).toFixed(2)+'%',
    (r.evPerEuro>=0?'+':'')+r.evPerEuro.toFixed(4),
    r.kelly.toFixed(2),
    csvEscape(r.decision)
  ].join(',')));
  return lines.join('\n');
}

/*** 4) Greitas REALAUS REZULTATO fiksavimas → rašo į RISK_KEY ir atnaujina grafiką ***/
function loadRisk(){
  try{
    const raw=localStorage.getItem(RISK_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveRisk(d){
  localStorage.setItem(RISK_KEY, JSON.stringify(d));
}
function ensureRiskDefaults(d){
  if(!d) d={};
  d.bank = +d.bank || 1000;
  d.cap  = +d.cap  || 1.0;
  d.dloss= +d.dloss|| 3.0;
  d.wloss= +d.wloss|| 7.0;
  d.wstart = d.wstart || new Date().toISOString().slice(0,10);
  d.dayPL = +d.dayPL || 0;
  d.weekPL= +d.weekPL|| 0;
  d.log = Array.isArray(d.log) ? d.log : [];
  return d;
}
function addResult(){
  const S = +$('rStake').value || 0;
  const o = +$('rOdd').value || 0;
  const res = $('rRes').value;
  let pl=0;
  if(res==='win') pl=S*(o-1);
  if(res==='loss') pl=-S;
  if(res==='void') pl=0;

  let d = ensureRiskDefaults(loadRisk());
  d.dayPL += pl;
  d.weekPL += pl;
  d.log.push({ t: new Date().toLocaleString(), S, o, res, pl });

  saveRisk(d);
  $('rMsg').textContent = `Įrašyta: ${res.toUpperCase()} • P&L ${pl>=0?'+':''}${pl.toFixed(2)} €`;
  renderPL(); // iškart atnaujinam grafiką
}

/*** 5) 📈 P&L grafikas iš RISK_KEY ***/
function getRiskLog(){
  const d = loadRisk();
  return (d && Array.isArray(d.log)) ? d.log : [];
}
function renderPL(){
  const svg = document.getElementById('plChart');
  const note = document.getElementById('plNote');
  if(!svg) return;

  const log = getRiskLog();
  svg.innerHTML = '';
  if(!log.length){
    if(note) note.innerHTML = 'Nėra įrašų. Užfiksuok rezultatą aukščiau ir atnaujink grafiką.';
    return;
  }
  const rows = log.slice().sort((a,b)=> new Date(a.t) - new Date(b.t));

  const xs=[], ys=[]; let sum=0;
  rows.forEach((r,idx)=>{ sum += (+r.pl||0); xs.push(idx); ys.push(sum); });

  const W=600, H=240, pad=28;
  const minY = Math.min(0, ...ys), maxY = Math.max(0, ...ys);
  const spanY = (maxY - minY) || 1;
  const spanX = Math.max(1, xs.length-1);
  const X = i => pad + (i/spanX)*(W-2*pad);
  const Y = v => H-pad - ((v-minY)/spanY)*(H-2*pad);

  const zeroY = Y(0);
  svg.insertAdjacentHTML('beforeend', `<line x1="${pad}" y1="${zeroY}" x2="${W-pad}" y2="${zeroY}" stroke="#2a3b52" stroke-dasharray="4 4"/>`);
  svg.insertAdjacentHTML('beforeend', `<rect x="0" y="0" width="${W}" height="${H}" fill="none"/>`);

  let dPath='';
  xs.forEach((x,i)=>{ const px=X(x), py=Y(ys[i]); dPath += (i?'L':'M')+px+' '+py+' '; });
  svg.insertAdjacentHTML('beforeend', `<path d="${dPath}" fill="none" stroke="#13c2a3" stroke-width="2.2"/>`);

  const lastX = X(xs[xs.length-1]), lastY = Y(ys[ys.length-1]);
  svg.insertAdjacentHTML('beforeend', `<circle cx="${lastX}" cy="${lastY}" r="3.5" fill="#13c2a3"/>`);

  const lbl = v => '€ '+v.toFixed(2);
  svg.insertAdjacentHTML('beforeend', `<text x="${pad}" y="${Y(maxY)-6}" fill="#90a4ae" font-size="11">${lbl(maxY)}</text>`);
  svg.insertAdjacentHTML('beforeend', `<text x="${pad}" y="${Y(minY)+12}" fill="#90a4ae" font-size="11">${lbl(minY)}</text>`);
  svg.insertAdjacentHTML('beforeend', `<text x="${lastX+6}" y="${lastY-6}" fill="#e8eef5" font-size="12" font-weight="700">${lbl(ys[ys.length-1])}</text>`);

  if(note) note.innerHTML = `Įrašai: ${rows.length} • Paskutinis P&L: <b>€ ${ys[ys.length-1].toFixed(2)}</b>`;
}

/*** EVENTAI ***/
$('calc').addEventListener('click',parseOdds);
$('kgo').addEventListener('click',kelly);
$('addlog').addEventListener('click',addToLog);
$('dlcsv').addEventListener('click',()=>download('mazylis_log.csv',toCSV()));
$('clear').addEventListener('click',()=>{ if(confirm('Išvalyti žurnalą?')){ localStorage.setItem(LOG_KEY,'[]'); renderLog(); } });

$('rCommit').addEventListener('click',addResult);
$('refreshPL').addEventListener('click',renderPL);

renderLog();
</script>
</body>
</html>
