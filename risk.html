<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ›¡ï¸ Rizikos modulis â€“ risk.html</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e1116">
<style>
  :root{
    --bg:#0e1116; --ink:#e8eef5; --mut:#90a4ae;
    --card:#131a21; --edge:#1e2a38; --btn:#0dbf9b; --btn-ink:#07211c;
    --ok:#2ecc71; --bad:#e57373; --warn:#f9a825;
  }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--ink);padding:18px}
  header,main{max-width:980px;margin:0 auto}
  h1{margin:0 0 10px;font-size:1.6rem}
  .note{color:var(--mut);font-size:.9rem}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:12px;padding:16px;margin:0 0 14px}
  label{display:block;margin:6px 0 4px;color:var(--mut)}
  input,select{width:100%;padding:10px;border-radius:8px;background:#101821;color:var(--ink);border:1px solid #263445}
  button{padding:10px 14px;border-radius:10px;background:var(--btn);color:var(--btn-ink);font-weight:700;border:0;cursor:pointer}
  .row{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  .row-3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  .ghost{background:#223041;color:#e8eef5}
  .danger{background:#c0392b;color:#fff}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700}
  .good{background:rgba(46,204,113,.15);color:var(--ok);border:1px solid rgba(46,204,113,.35)}
  .bad{background:rgba(229,115,115,.12);color:var(--bad);border:1px solid rgba(229,115,115,.35)}
  .warn{background:rgba(249,168,37,.12);color:var(--warn);border:1px solid rgba(249,168,37,.35)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #223140;text-align:right}
  th:first-child,td:first-child{text-align:left}
  th{color:var(--mut);font-weight:600}
  svg{display:block}
</style>
</head>
<body>
<header>
  <h1>ğŸ›¡ï¸ Rizikos modulis</h1>
  <p class="note">ÄŒia valdai bankrolÄ…, cap limitÄ…, dienos/savaitÄ—s STOP, fiksuoji realius rezultatus ir matai P&L grafikÄ…. Duomenys saugomi tavo Ä¯renginyje.</p>
</header>

<main>
  <!-- 1) Nustatymai -->
  <section class="card">
    <h3 style="margin:0 0 8px">âš™ï¸ Nustatymai</h3>
    <div class="row">
      <div>
        <label for="bank">Bankrolas (â‚¬)</label>
        <input id="bank" type="number" step="0.01" value="1000">
      </div>
      <div>
        <label for="cap">Cap (% vienam statymui)</label>
        <input id="cap" type="number" step="0.01" value="1.0">
      </div>
      <div>
        <label for="dloss">Dienos STOP (% nuo bankrolo)</label>
        <input id="dloss" type="number" step="0.1" value="3.0">
      </div>
      <div>
        <label for="wloss">SavaitÄ—s STOP (% nuo bankrolo)</label>
        <input id="wloss" type="number" step="0.1" value="7.0">
      </div>
    </div>
    <div class="btns" style="margin-top:10px">
      <button id="save">ğŸ’¾ IÅ¡saugoti</button>
      <button id="resetAll" class="ghost">â™»ï¸ Atstatyti numatytuosius</button>
    </div>
    <p class="note" id="msg"></p>
  </section>

  <!-- 2) BÅ«sena + STOP indikatoriai -->
  <section class="card">
    <h3 style="margin:0 0 8px">ğŸ“Š BÅ«sena</h3>
    <div class="row-3">
      <div>
        <div class="note">Dienos P&L</div>
        <div id="dayPL" style="font-weight:800;font-size:1.2rem">â‚¬ 0.00</div>
      </div>
      <div>
        <div class="note">SavaitÄ—s P&L</div>
        <div id="weekPL" style="font-weight:800;font-size:1.2rem">â‚¬ 0.00</div>
      </div>
      <div>
        <div class="note">Cap limitas</div>
        <div id="capMax" style="font-weight:800;font-size:1.2rem">â‚¬ 0.00</div>
      </div>
    </div>
    <p id="stopNote" class="note" style="margin-top:8px"></p>
    <div class="btns" style="margin-top:8px">
      <button id="resetDay" class="ghost">ğŸ§¹ NulinÄ— diena</button>
      <button id="resetWeek" class="ghost">ğŸ—“ï¸ Nauja savaitÄ— (nuo Å¡iandien)</button>
    </div>
  </section>

  <!-- 3) Greitas realaus rezultato fiksavimas -->
  <section class="card">
    <h3 style="margin:0 0 8px">âœ… Greitas rezultato fiksavimas</h3>
    <div class="row">
      <div>
        <label for="rStake">Statymas (â‚¬)</label>
        <input id="rStake" type="number" step="0.01" value="10">
      </div>
      <div>
        <label for="rOdd">Koeficientas</label>
        <input id="rOdd" type="number" step="0.01" value="2.00">
      </div>
      <div>
        <label for="rRes">Rezultatas</label>
        <select id="rRes">
          <option value="win">LaimÄ—jo</option>
          <option value="loss">PralaimÄ—jo</option>
          <option value="void">Void / GrÄ…Å¾inta</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="commit">ğŸ’¾ Ä®raÅ¡yti rezultatÄ…</button>
      </div>
    </div>
    <p class="note" id="rMsg"></p>
  </section>

  <!-- 4) P&L grafikas -->
  <section class="card">
    <h3 style="margin:0 0 8px">ğŸ“ˆ P&L grafikas</h3>
    <div class="btns">
      <button id="refresh" class="ghost">ğŸ”„ Atnaujinti</button>
    </div>
    <div style="margin-top:10px;background:#101821;border:1px solid #223140;border-radius:10px;padding:8px">
      <svg id="plChart" viewBox="0 0 600 240" preserveAspectRatio="none" style="width:100%;height:220px"></svg>
      <div id="plNote" class="note">Grafikas naudoja tavo Ä¯raÅ¡Å³ istorijÄ… (Å¾emiau).</div>
    </div>
  </section>

  <!-- 5) Å½urnalas -->
  <section class="card">
    <h3 style="margin:0 0 8px">ğŸ“’ Å½urnalas</h3>
    <div class="btns">
      <button id="exportCsv">â¬‡ï¸ Eksportuoti CSV</button>
      <button id="undo" class="ghost">â†©ï¸ AtÅ¡aukti paskutinÄ¯</button>
      <button id="clearLog" class="danger">ğŸ§¨ IÅ¡valyti visÄ… Å¾urnalÄ…</button>
    </div>
    <table id="logtbl" style="display:none">
      <thead>
        <tr>
          <th>Laikas</th><th>Statymas</th><th>Koef.</th><th>Rez.</th><th>P&L</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="note">Pastaba: jei nori, tÄ… patÄ¯ greitÄ… Ä¯raÅ¡ymÄ… turi ir <b>prob.html</b> â€“ abu puslapiai naudoja tÄ… paÄiÄ… saugyklÄ….</p>
  </section>
</main>

<script>
/* ====== SAUGYKLA ====== */
const KEY = 'mazylis_risk_v1';
const $ = id => document.getElementById(id);

function load(){
  try{ const raw=localStorage.getItem(KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; }
}
function save(d){ localStorage.setItem(KEY, JSON.stringify(d)); }
function defaults(d){
  if(!d) d={};
  d.bank = +d.bank || 1000;
  d.cap  = +d.cap  || 1.0;
  d.dloss= +d.dloss|| 3.0;
  d.wloss= +d.wloss|| 7.0;
  d.wstart = d.wstart || new Date().toISOString().slice(0,10);
  d.dayPL = +d.dayPL || 0;
  d.weekPL= +d.weekPL|| 0;
  d.log = Array.isArray(d.log)? d.log : [];
  return d;
}

/* ====== UI ATNAUJINIMAS ====== */
function fmtEur(v){ return 'â‚¬ ' + (Number(v)||0).toFixed(2); }
function setMsg(text){ $('msg').textContent=text; }

function syncInputs(){
  let d = defaults(load());
  $('bank').value = d.bank;
  $('cap').value  = d.cap;
  $('dloss').value= d.dloss;
  $('wloss').value= d.wloss;

  $('dayPL').textContent  = fmtEur(d.dayPL);
  $('weekPL').textContent = fmtEur(d.weekPL);
  $('capMax').textContent = fmtEur(d.bank * (d.cap/100));

  const dayStop = -(d.bank * (d.dloss/100));
  const weekStop= -(d.bank * (d.wloss/100));
  let note = `Dienos STOP: ${fmtEur(dayStop)} â€¢ SavaitÄ—s STOP: ${fmtEur(weekStop)}. `;
  const hitStop = (d.dayPL <= dayStop) || (d.weekPL <= weekStop);
  note += hitStop
    ? `<span class="pill bad">ğŸ›‘ STOP pasiektas â€“ nestatyti</span>`
    : `<span class="pill good">âœ… Saugikliai neperÅ¾engti</span>`;
  $('stopNote').innerHTML = note;

  renderLog();
}

/* ====== VEIKSMAI ====== */
function saveSettings(){
  let d = defaults(load());
  d.bank = +$('bank').value || 0;
  d.cap  = +$('cap').value  || 0;
  d.dloss= +$('dloss').value|| 0;
  d.wloss= +$('wloss').value|| 0;
  save(d);
  setMsg('IÅ¡saugota âœ”ï¸'); syncInputs();
}

function resetDefaults(){
  localStorage.removeItem(KEY);
  setMsg('Atstatyta Ä¯ numatytuosius.'); syncInputs();
}

function resetDay(){
  let d = defaults(load()); d.dayPL = 0; save(d); syncInputs();
}
function resetWeek(){
  let d = defaults(load()); d.weekPL=0; d.wstart = new Date().toISOString().slice(0,10); save(d); syncInputs();
}

function commitResult(){
  const S = +$('rStake').value || 0;
  const o = +$('rOdd').value || 0;
  const res = $('rRes').value;
  let pl=0; if(res==='win') pl=S*(o-1); if(res==='loss') pl=-S; if(res==='void') pl=0;
  let d = defaults(load());
  d.dayPL += pl; d.weekPL += pl;
  d.log.push({ t:new Date().toLocaleString(), S, o, res, pl });
  save(d);
  $('rMsg').textContent = `Ä®raÅ¡yta: ${res.toUpperCase()} â€¢ P&L ${pl>=0?'+':''}${pl.toFixed(2)} â‚¬`;
  syncInputs(); renderPL();
}

function undoLast(){
  let d = defaults(load());
  if(!d.log.length){ alert('Å½urnalas tuÅ¡Äias.'); return; }
  const last = d.log.pop();
  d.dayPL -= (+last.pl||0);
  d.weekPL-= (+last.pl||0);
  save(d); syncInputs(); renderPL();
}

function clearLog(){
  if(!confirm('Tikrai iÅ¡valyti VISÄ„ Å¾urnalÄ…?')) return;
  let d = defaults(load()); d.log=[]; d.dayPL=0; d.weekPL=0; save(d); syncInputs(); renderPL();
}

/* ====== Å½URNALAS & CSV ====== */
function renderLog(){
  const table = $('logtbl'); const tb = table.querySelector('tbody');
  const d = defaults(load()); const rows = d.log || [];
  tb.innerHTML='';
  rows.slice(-400).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left">${r.t}</td>
      <td>${r.S?.toFixed(2) ?? '0.00'} â‚¬</td>
      <td>${r.o?.toFixed(2) ?? '-'}</td>
      <td style="text-transform:uppercase;text-align:center">${r.res || '-'}</td>
      <td>${(r.pl>=0?'+':'')}${(r.pl||0).toFixed(2)} â‚¬</td>`;
    tb.appendChild(tr);
  });
  table.style.display = rows.length ? 'table' : 'none';
}

function exportCSV(){
  const d = defaults(load()); const rows = d.log || [];
  const header = ['time','stake_eur','odds','result','pl_eur'];
  const esc = v => {
    v = (v==null?'':String(v));
    return /[",\n]/.test(v)?('"'+v.replace(/"/g,'""')+'"'):v;
  };
  const lines = [header.join(',')].concat(rows.map(r=>[
    esc(r.t), (r.S||0).toFixed(2), (r.o||0).toFixed(2), esc(r.res||''), (r.pl||0).toFixed(2)
  ].join(',')));
  const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='risk_log.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
}

/* ====== P&L GRAFIKAS ====== */
function renderPL(){
  const svg = $('plChart'), note = $('plNote'); svg.innerHTML='';
  const d = defaults(load()); const log = d.log || [];
  if(!log.length){ if(note) note.textContent='NÄ—ra Ä¯raÅ¡Å³.'; return; }

  const rows = log.slice().sort((a,b)=> new Date(a.t) - new Date(b.t));
  const xs=[], ys=[]; let sum=0;
  rows.forEach((r,i)=>{ sum += (+r.pl||0); xs.push(i); ys.push(sum); });

  const W=600,H=240,pad=28;
  const minY = Math.min(0, ...ys), maxY=Math.max(0, ...ys);
  const spanY=(maxY-minY)||1, spanX=Math.max(1, xs.length-1);
  const X=i=> pad + (i/spanX)*(W-2*pad);
  const Y=v=> H-pad - ((v-minY)/spanY)*(H-2*pad);

  const zeroY = Y(0);
  svg.insertAdjacentHTML('beforeend', `<line x1="${pad}" y1="${zeroY}" x2="${W-pad}" y2="${zeroY}" stroke="#2a3b52" stroke-dasharray="4 4"/>`);
  svg.insertAdjacentHTML('beforeend', `<rect x="0" y="0" width="${W}" height="${H}" fill="none"/>`);

  let dPath=''; xs.forEach((x,i)=>{ const px=X(x), py=Y(ys[i]); dPath += (i?'L':'M')+px+' '+py+' '; });
  svg.insertAdjacentHTML('beforeend', `<path d="${dPath}" fill="none" stroke="#13c2a3" stroke-width="2.2"/>`);

  const lastX=X(xs[xs.length-1]), lastY=Y(ys[ys.length-1]);
  svg.insertAdjacentHTML('beforeend', `<circle cx="${lastX}" cy="${lastY}" r="3.5" fill="#13c2a3"/>`);

  const lbl=v=>'â‚¬ '+v.toFixed(2);
  svg.insertAdjacentHTML('beforeend', `<text x="${pad}" y="${Y(maxY)-6}" fill="#90a4ae" font-size="11">${lbl(maxY)}</text>`);
  svg.insertAdjacentHTML('beforeend', `<text x="${pad}" y="${Y(minY)+12}" fill="#90a4ae" font-size="11">${lbl(minY)}</text>`);
  svg.insertAdjacentHTML('beforeend', `<text x="${lastX+6}" y="${lastY-6}" fill="#e8eef5" font-size="12" font-weight="700">${lbl(ys[ys.length-1])}</text>`);

  if(note) note.innerHTML = `Ä®raÅ¡ai: ${rows.length} â€¢ Paskutinis P&L: <b>${lbl(ys[ys.length-1])}</b>`;
}

/* ====== EVENTAI ====== */
$('save').addEventListener('click', saveSettings);
$('resetAll').addEventListener('click', resetDefaults);
$('resetDay').addEventListener('click', resetDay);
$('resetWeek').addEventListener('click', resetWeek);
$('commit').addEventListener('click', commitResult);
$('undo').addEventListener('click', undoLast);
$('clearLog').addEventListener('click', clearLog);
$('exportCsv').addEventListener('click', exportCSV);
$('refresh').addEventListener('click', renderPL);

/* INIT */
syncInputs(); renderPL();

/* PWA registracija */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
        </html>
